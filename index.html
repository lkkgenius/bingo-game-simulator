<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <title>BingoéŠæˆ²æ¨¡æ“¬å™¨</title>

    <!-- PWA Meta Tags -->
    <meta
      name="description"
      content="ä¸€å€‹åˆä½œå¼ Bingo éŠæˆ²æ¨¡æ“¬å™¨ï¼Œç©å®¶èˆ‡é›»è…¦åˆä½œå®Œæˆé€£ç·š"
    />
    <meta name="theme-color" content="#5C6BC0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Bingoæ¨¡æ“¬å™¨" />
    <meta name="msapplication-TileColor" content="#4A90E2" />
    <meta name="msapplication-config" content="./browserconfig.xml" />

    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json" />

    <!-- Icons -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./icons/favicon-16x16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./icons/apple-touch-icon.png"
    />
    <link
      rel="mask-icon"
      href="./icons/safari-pinned-tab.svg"
      color="#5C6BC0"
    />

    <!-- Preload Critical Resources -->
    <link rel="preload" href="./styles.css" as="style" />
    <link rel="preload" href="./script.js" as="script" />
    <link rel="preload" href="./gameEngine.js" as="script" />

    <link rel="stylesheet" href="./styles.css" />
    <style>
      /* èªè¨€é¸æ“‡å€åŸŸæ¨£å¼ */
      .header-top {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
      }

      .language-selector {
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-width: 200px;
      }

      .language-selector h3 {
        color: #2c3e50;
        margin: 0 0 10px 0;
        font-size: 1rem;
        text-align: center;
      }

      .language-options {
        display: flex;
        gap: 8px;
      }

      .language-option {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        color: #2c3e50;
      }

      .language-option:hover {
        border-color: #3498db;
        background-color: #f8f9fa;
      }

      .language-option.selected {
        border-color: #3498db;
        background-color: #ebf5fb;
        color: #2980b9;
        font-weight: bold;
      }

      .language-option:focus {
        outline: 2px solid #3498db;
        outline-offset: 2px;
      }

      /* æ¼”ç®—æ³•é¸æ“‡å€åŸŸæ¨£å¼ */
      .algorithm-selector {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .algorithm-selector h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .algorithm-options {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .algorithm-option {
        flex: 1;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .algorithm-option:hover {
        border-color: #3498db;
        background-color: #f8f9fa;
      }

      .algorithm-option.selected {
        border-color: #3498db;
        background-color: #ebf5fb;
        box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
      }

      .algorithm-name {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }

      .algorithm-description {
        color: #34495e;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .algorithm-features {
        margin-top: 10px;
        padding-left: 20px;
        font-size: 0.85rem;
      }

      .algorithm-features li {
        margin-bottom: 5px;
        color: #34495e;
      }

      /* ç•¶å‰æ¼”ç®—æ³•æŒ‡ç¤ºå™¨ */
      .current-algorithm {
        background-color: #ebf5fb;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.9rem;
        color: #2980b9;
        display: inline-block;
        margin-top: 10px;
      }

      /* èªè¨€åˆ‡æ›æ¶ˆæ¯æ¨£å¼ */
      .language-change-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        font-size: 14px;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }

      /* è‹±æ–‡ç‰ˆæœ¬çš„ä½ˆå±€èª¿æ•´ */
      [lang='en-US'] .algorithm-name {
        font-size: 1rem;
      }

      [lang='en-US'] .algorithm-description {
        font-size: 0.85rem;
      }

      [lang='en-US'] .algorithm-features {
        font-size: 0.8rem;
      }

      [lang='en-US'] .language-option {
        font-size: 0.85rem;
        padding: 6px 10px;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ - è‹±æ–‡ç‰ˆæœ¬ */
      @media (max-width: 768px) {
        [lang='en-US'] .algorithm-options {
          flex-direction: column;
        }

        [lang='en-US'] .algorithm-option {
          margin-bottom: 10px;
        }

        [lang='en-US'] .language-options {
          flex-direction: column;
          gap: 5px;
        }
      }

      /* æ•¸å­—å’Œæ—¥æœŸæ ¼å¼åŒ–æ¨£å¼ */
      .formatted-number {
        font-weight: bold;
        color: #2c3e50;
      }

      .formatted-percentage {
        color: #27ae60;
        font-weight: bold;
      }

      .formatted-position {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header role="banner">
        <div class="header-top">
          <div
            class="language-selector"
            role="region"
            aria-labelledby="language-selector-title"
          >
            <h3
              id="language-selector-title"
              data-i18n="language.selector.title"
            >
              èªè¨€é¸æ“‡
            </h3>
            <div class="language-options">
              <button
                class="language-option selected"
                data-language="zh-TW"
                aria-pressed="true"
              >
                <span data-i18n="language.chinese">ç¹é«”ä¸­æ–‡</span>
              </button>
              <button
                class="language-option"
                data-language="en-US"
                aria-pressed="false"
              >
                <span data-i18n="language.english">English</span>
              </button>
            </div>
          </div>
        </div>
        <h1 data-i18n="header.title">BingoéŠæˆ²æ¨¡æ“¬å™¨</h1>
        <p class="game-description" data-i18n="header.description">
          èˆ‡é›»è…¦é€²è¡Œ8è¼ªç¿»ç‰ŒéŠæˆ²ï¼Œç›®æ¨™æ˜¯å®Œæˆæœ€å¤šçš„é€£ç·šï¼
        </p>
        <div id="debug-hint" class="debug-hint" style="display: none">
          ğŸ’¡ æŒ‰ <kbd>Ctrl+Shift+D</kbd> é–‹å•Ÿèª¿è©¦æ¨¡å¼ï¼Œæˆ–åœ¨URLå¾ŒåŠ ä¸Š
          <code>?debug=true</code>
        </div>
      </header>

      <main role="main">
        <div
          class="algorithm-selector"
          role="region"
          aria-labelledby="algorithm-selector-title"
        >
          <h3
            id="algorithm-selector-title"
            data-i18n="algorithm.selector.title"
          >
            é¸æ“‡æ¼”ç®—æ³•
          </h3>
          <div class="algorithm-options">
            <div class="algorithm-option selected" data-algorithm="standard">
              <div class="algorithm-name" data-i18n="algorithm.standard.name">
                æ¨™æº–æ¼”ç®—æ³•
              </div>
              <div
                class="algorithm-description"
                data-i18n="algorithm.standard.description"
              >
                åŸºæœ¬çš„æ©Ÿç‡è¨ˆç®—ï¼Œå¹³è¡¡è€ƒæ…®å„ç¨®å› ç´ 
              </div>
              <ul class="algorithm-features">
                <li data-i18n="algorithm.standard.features.1">åŸºæœ¬é€£ç·šæª¢æ¸¬</li>
                <li data-i18n="algorithm.standard.features.2">
                  ç°¡å–®çš„æ©Ÿç‡è¨ˆç®—
                </li>
                <li data-i18n="algorithm.standard.features.3">ä¸­å¿ƒä½ç½®çå‹µ</li>
              </ul>
            </div>
            <div class="algorithm-option" data-algorithm="enhanced">
              <div class="algorithm-name" data-i18n="algorithm.enhanced.name">
                å¢å¼·æ¼”ç®—æ³•
              </div>
              <div
                class="algorithm-description"
                data-i18n="algorithm.enhanced.description"
              >
                å°ˆæ³¨æ–¼æœ€å¤§åŒ–å®Œæˆä¸‰æ¢é€£ç·šçš„æ©Ÿæœƒ
              </div>
              <ul class="algorithm-features">
                <li data-i18n="algorithm.enhanced.features.1">
                  äº¤å‰é»å„ªå…ˆç­–ç•¥
                </li>
                <li data-i18n="algorithm.enhanced.features.2">
                  æ¥è¿‘å®Œæˆçš„ç·šå„ªå…ˆ
                </li>
                <li data-i18n="algorithm.enhanced.features.3">æˆ°ç•¥ä½ç½®è©•ä¼°</li>
                <li data-i18n="algorithm.enhanced.features.4">å¤šç·šå®Œæˆçå‹µ</li>
              </ul>
            </div>
            <div class="algorithm-option" data-algorithm="ai-learning">
              <div
                class="algorithm-name"
                data-i18n="algorithm.ai-learning.name"
              >
                AI å­¸ç¿’æ¼”ç®—æ³•
              </div>
              <div
                class="algorithm-description"
                data-i18n="algorithm.ai-learning.description"
              >
                åŸºæ–¼æ©Ÿå™¨å­¸ç¿’çš„æ™ºèƒ½å»ºè­°ç³»çµ±
              </div>
              <ul class="algorithm-features">
                <li data-i18n="algorithm.ai-learning.features.1">
                  æ­·å²æ•¸æ“šå­¸ç¿’
                </li>
                <li data-i18n="algorithm.ai-learning.features.2">
                  è¡Œç‚ºæ¨¡å¼é æ¸¬
                </li>
                <li data-i18n="algorithm.ai-learning.features.3">
                  è‡ªé©æ‡‰é›£åº¦èª¿æ•´
                </li>
                <li data-i18n="algorithm.ai-learning.features.4">
                  å€‹æ€§åŒ–éŠæˆ²é«”é©—
                </li>
              </ul>
            </div>
          </div>
          <div class="current-algorithm">
            <span data-i18n="algorithm.current">ç•¶å‰ä½¿ç”¨</span>:
            <span
              id="current-algorithm-name"
              data-i18n="algorithm.standard.name"
              >æ¨™æº–æ¼”ç®—æ³•</span
            >
          </div>
        </div>

        <div
          class="game-status"
          role="status"
          aria-live="polite"
          data-i18n-aria="aria.game-status"
        >
          <div class="status-item">
            <span class="label" data-i18n="status.current-round">ç•¶å‰è¼ªæ•¸</span
            >:
            <span
              id="current-round"
              class="value"
              data-i18n-aria="aria.current-round"
              >1</span
            >
            <span class="total"
              >/ <span data-i18n="status.total-rounds">8</span></span
            >
          </div>
          <div class="status-item">
            <span class="label" data-i18n="status.game-phase">éŠæˆ²éšæ®µ</span>:
            <span
              id="game-phase"
              class="value"
              data-i18n="phase.player-turn"
              data-i18n-aria="aria.game-phase"
              >ç©å®¶å›åˆ</span
            >
          </div>
          <div class="status-item">
            <span class="label" data-i18n="status.completed-lines"
              >å®Œæˆé€£ç·š</span
            >:
            <span
              id="completed-lines"
              class="value"
              data-i18n-aria="aria.completed-lines"
              >0</span
            >
          </div>
        </div>

        <!-- AI å­¸ç¿’ç³»çµ±ç‹€æ…‹ -->
        <div id="ai-learning-status" class="ai-learning-status hidden">
          <h3 data-i18n="ai.status.title">AI å­¸ç¿’ç³»çµ±ç‹€æ…‹</h3>
          <div class="ai-stats">
            <div class="ai-stat-item">
              <span class="label" data-i18n="ai.status.skill-level"
                >æŠ€èƒ½ç­‰ç´š</span
              >:
              <span id="skill-level" class="value">50%</span>
            </div>
            <div class="ai-stat-item">
              <span class="label" data-i18n="ai.status.play-style"
                >éŠæˆ²é¢¨æ ¼</span
              >:
              <span id="play-style" class="value" data-i18n="ai.style.balanced"
                >å¹³è¡¡å‹</span
              >
            </div>
            <div class="ai-stat-item">
              <span class="label" data-i18n="ai.status.difficulty-level"
                >é›£åº¦ç­‰ç´š</span
              >:
              <span
                id="difficulty-level"
                class="value"
                data-i18n="ai.difficulty.medium"
                >ä¸­ç­‰</span
              >
            </div>
            <div class="ai-stat-item">
              <span class="label" data-i18n="ai.status.games-played"
                >å·²ç©éŠæˆ²</span
              >:
              <span id="games-played" class="value">0</span>
            </div>
          </div>
          <div class="ai-controls">
            <button
              id="reset-ai-learning"
              class="secondary-btn"
              data-i18n="ai.controls.reset"
            >
              é‡ç½®å­¸ç¿’æ•¸æ“š
            </button>
            <button
              id="export-learning-data"
              class="secondary-btn"
              data-i18n="ai.controls.export"
            >
              å°å‡ºå­¸ç¿’æ•¸æ“š
            </button>
            <input
              type="file"
              id="import-learning-data"
              accept=".json"
              style="display: none"
            />
            <button
              id="import-learning-data-btn"
              class="secondary-btn"
              data-i18n="ai.controls.import"
            >
              å°å…¥å­¸ç¿’æ•¸æ“š
            </button>
          </div>
        </div>

        <div class="game-board-container">
          <div
            id="game-board"
            class="game-board"
            role="grid"
            data-i18n-aria="aria.game-board"
            tabindex="0"
          ></div>
          <div
            class="board-controls"
            role="group"
            data-i18n-aria="aria.game-controls"
          >
            <button
              id="start-game"
              class="primary-btn"
              aria-describedby="game-instructions"
              data-i18n="controls.start-game"
            >
              é–‹å§‹éŠæˆ²
            </button>
            <button
              id="restart-game"
              class="secondary-btn"
              disabled
              data-i18n="controls.restart-game"
              data-i18n-aria="controls.restart-game"
            >
              é‡æ–°é–‹å§‹
            </button>
            <button
              id="random-computer-move"
              class="secondary-btn"
              data-i18n="controls.random-computer-move"
              data-i18n-aria="controls.random-computer-move"
            >
              é›»è…¦éš¨æ©Ÿä¸‹æ£‹
            </button>
            <div class="auto-random-container">
              <input
                type="checkbox"
                id="auto-random-move"
                aria-describedby="auto-random-description"
              />
              <label
                for="auto-random-move"
                data-i18n="controls.auto-random-move"
                >é›»è…¦è‡ªå‹•éš¨æ©Ÿä¸‹æ£‹</label
              >
              <div
                id="auto-random-description"
                class="sr-only"
                data-i18n="controls.auto-random-description"
              >
                å•Ÿç”¨å¾Œï¼Œé›»è…¦å°‡åœ¨æ¯å›åˆè‡ªå‹•éš¨æ©Ÿé¸æ“‡ä½ç½®
              </div>
            </div>
          </div>
        </div>

        <div class="control-panel">
          <div id="game-result-panel" class="result-panel hidden">
            <h3 data-i18n="results.game-over">éŠæˆ²çµæŸï¼</h3>
            <div class="final-stats">
              <div class="stat-item">
                <span class="stat-label" data-i18n="results.total-lines"
                  >ç¸½é€£ç·šæ•¸:</span
                >
                <span id="final-lines-count" class="stat-value">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label" data-i18n="results.player-moves"
                  >ç©å®¶ç§»å‹•:</span
                >
                <span id="player-moves-count" class="stat-value">8</span>
              </div>
              <div class="stat-item">
                <span class="stat-label" data-i18n="results.computer-moves"
                  >é›»è…¦ç§»å‹•:</span
                >
                <span id="computer-moves-count" class="stat-value">8</span>
              </div>
            </div>
            <button
              id="play-again"
              class="primary-btn"
              data-i18n="results.play-again"
            >
              å†ç©ä¸€æ¬¡
            </button>
          </div>

          <div id="game-active-panel">
            <div
              class="suggestion-area"
              role="region"
              data-i18n-aria="aria.move-suggestion"
              aria-live="polite"
            >
              <h3 data-i18n="suggestion.title">å»ºè­°ç§»å‹•</h3>
              <div
                id="suggestion-display"
                class="suggestion-display"
                data-i18n-aria="aria.move-suggestion"
              >
                <span id="suggestion-text" data-i18n="suggestion.default"
                  >é»æ“Šé–‹å§‹éŠæˆ²ç²å¾—å»ºè­°</span
                >
              </div>
            </div>

            <div class="input-area">
              <h3 data-i18n="computer.input.title">é›»è…¦é¸æ“‡è¼¸å…¥</h3>
              <div class="computer-input">
                <p
                  id="computer-turn-message"
                  data-i18n="computer.input.message"
                >
                  é›»è…¦å›åˆæ™‚ï¼Œè«‹ç›´æ¥é»æ“Šæ£‹ç›¤ä¸Šçš„ç©ºæ ¼å­æˆ–ä½¿ç”¨æ£‹ç›¤æ—çš„éš¨æ©Ÿä¸‹æ£‹æŒ‰éˆ•
                </p>
              </div>
            </div>

            <div class="game-controls"></div>

            <!-- èª¿è©¦å€åŸŸ -->
            <div id="debug-panel" class="debug-panel" style="display: none">
              <h3>ğŸ”§ é€£ç·šé¡¯ç¤ºèª¿è©¦</h3>
              <div class="debug-controls">
                <button id="debug-test-horizontal" class="debug-btn">
                  æ¸¬è©¦æ°´å¹³ç·š
                </button>
                <button id="debug-test-vertical" class="debug-btn">
                  æ¸¬è©¦å‚ç›´ç·š
                </button>
                <button id="debug-test-diagonal" class="debug-btn">
                  æ¸¬è©¦å°è§’ç·š
                </button>
                <button id="debug-test-multiple" class="debug-btn">
                  æ¸¬è©¦å¤šæ¢ç·š
                </button>
                <button id="debug-clear-board" class="debug-btn">
                  æ¸…ç©ºæ¸¬è©¦
                </button>
                <button id="debug-force-refresh" class="debug-btn">
                  å¼·åˆ¶åˆ·æ–°é€£ç·š
                </button>
              </div>
              <div id="debug-info" class="debug-info">
                <p>èª¿è©¦ä¿¡æ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>
              </div>
            </div>
          </div>
        </div>

        <div
          class="instructions"
          role="region"
          aria-labelledby="instructions-title"
        >
          <h3 id="instructions-title" data-i18n="instructions.title">
            æ“ä½œæŒ‡ç¤º
          </h3>
          <div
            id="instruction-text"
            class="instruction-text"
            id="game-instructions"
            aria-live="polite"
            data-i18n="instructions.default"
          >
            é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•é–‹å§‹æ–°çš„éŠæˆ²ã€‚ä½¿ç”¨æ–¹å‘éµå°èˆªéŠæˆ²æ¿ï¼ŒæŒ‰ Enter
            æˆ–ç©ºæ ¼éµé¸æ“‡æ ¼å­ã€‚
          </div>
        </div>
      </main>

      <div id="game-results" class="hidden">
        <button id="play-again" class="primary-btn">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>

    <div id="global-loading" class="global-loading">
      <div class="loading-spinner"></div>
      <div class="loading-text" data-i18n="loading.components">
        æ­£åœ¨è¼‰å…¥éŠæˆ²çµ„ä»¶...
      </div>
    </div>

    <!-- Enhanced Script Loading Architecture -->
    <script src="./script-loader.js"></script>

    <script>
      // Enhanced Game Initialization with Refactored Script Loading
      // Uses the new modular loading architecture to eliminate global pollution
      // and implement conditional loading based on environment

      // Application state management (encapsulated to prevent global pollution)
      const BingoApp = {
        state: {
          currentAlgorithm: 'standard',
          gameInitialized: false,
          loadingProgress: 0,
          environment: null
        },
        
        components: {
          gameState: null,
          gameBoard: null,
          lineDetector: null,
          probabilityCalculator: null
        },

        // Initialize the application
        async initialize() {
          try {
            // Detect environment early
            this.state.environment = window.Environment ? window.Environment.getMode() : 'production';
            
            // Show loading indicator
            this.showLoadingState('æ­£åœ¨åˆå§‹åŒ–è¼‰å…¥ç³»çµ±...');
            
            // Initialize the enhanced script loader
            await window.scriptLoader.initialize();
            
            // Setup loading progress monitoring
            this.setupLoadingMonitoring();
            
            // Load all modules using the enhanced loading system
            this.showLoadingState('æ­£åœ¨è¼‰å…¥éŠæˆ²æ¨¡çµ„...');
            await window.scriptLoader.loadModules();
            
            // Setup game components after modules are loaded
            this.setupGameComponents();
            
            // Initialize UI and event handlers
            this.setupUserInterface();
            
            // Mark as initialized
            this.state.gameInitialized = true;
            
            // Hide loading and show success
            this.hideLoadingState();
            this.showInitializationSuccess();
            
            if (this.state.environment === 'development') {
              console.log('ğŸ® Bingo Game initialized successfully');
              console.log('Loader Status:', window.scriptLoader.getStatus());
            }
            
          } catch (error) {
            console.error('Failed to initialize Bingo Game:', error);
            this.handleInitializationError(error);
          }
        },

        // Setup loading progress monitoring
        setupLoadingMonitoring() {
          if (window.scriptLoader && window.scriptLoader.moduleLoader) {
            window.scriptLoader.moduleLoader.onProgress((progress) => {
              this.updateLoadingProgress(progress.percentage, `è¼‰å…¥ä¸­... ${progress.loaded}/${progress.total}`);
            });
          }
        },

        // Setup game components after modules are loaded
        setupGameComponents() {
          // Verify critical components are available
          const criticalComponents = ['LineDetector', 'ProbabilityCalculator', 'GameBoard', 'GameEngine'];
          const missingComponents = criticalComponents.filter(
            component => typeof window[component] === 'undefined'
          );

          if (missingComponents.length > 0) {
            console.warn('Missing critical components:', missingComponents);
            throw new Error(`Critical components missing: ${missingComponents.join(', ')}`);
          }

          // Initialize components (these will be available after module loading)
          this.components.lineDetector = window.LineDetector;
          this.components.probabilityCalculator = window.ProbabilityCalculator;
          this.components.gameBoard = window.GameBoard;
          this.components.gameEngine = window.GameEngine;

          if (this.state.environment === 'development') {
            console.log('âœ… All critical game components loaded successfully');
          }
        },

        // Setup user interface and event handlers
        setupUserInterface() {
          // Setup algorithm selection with on-demand loading
          this.setupAlgorithmSelection();
          
          // Setup game control buttons
          this.setupGameControls();
          
          // Setup accessibility features
          this.setupAccessibilityFeatures();
          
          // Setup language switching
          this.setupLanguageHandling();
          
          // Setup performance monitoring UI (development only)
          if (this.state.environment === 'development') {
            this.setupDevelopmentFeatures();
          }
        },

        // Setup algorithm selection with enhanced on-demand loading
        setupAlgorithmSelection() {
          const algorithmOptions = document.querySelectorAll('.algorithm-option');

          algorithmOptions.forEach(option => {
            option.addEventListener('click', async (event) => {
              const algorithm = option.getAttribute('data-algorithm');
              
              if (algorithm === this.state.currentAlgorithm) {
                return;
              }

              try {
                await this.switchAlgorithm(algorithm, option);
              } catch (error) {
                console.error(`Failed to switch to ${algorithm} algorithm:`, error);
                this.showAlgorithmError(option, error);
              }
            });
          });

          // Initially mark enhanced algorithms as loading
          this.markAlgorithmsAsLoading();
        },

        // Switch algorithm with on-demand loading
        async switchAlgorithm(algorithm, optionElement) {
          // Show loading state for the option
          this.showAlgorithmLoading(optionElement, algorithm);

          // Load algorithm module if needed
          if (algorithm === 'enhanced' && typeof window.EnhancedProbabilityCalculator === 'undefined') {
            await window.scriptLoader.loadOnDemand('probabilityCalculator.enhanced.js');
          } else if (algorithm === 'ai-learning' && typeof window.AILearningSystem === 'undefined') {
            await window.scriptLoader.loadOnDemand('aiLearningSystem.js');
          }

          // Update algorithm selection
          this.updateAlgorithmSelection(algorithm);
          this.state.currentAlgorithm = algorithm;

          // Show success state
          this.showAlgorithmLoaded(optionElement, algorithm);

          // Notify the game engine if it exists
          if (typeof window.switchAlgorithm === 'function') {
            window.switchAlgorithm(algorithm);
          }
        },

        // Setup game control buttons
        setupGameControls() {
          const startButton = document.getElementById('start-game');
          const restartButton = document.getElementById('restart-game');
          const randomMoveButton = document.getElementById('random-computer-move');
          const playAgainButton = document.getElementById('play-again');

          if (startButton) {
            startButton.addEventListener('click', () => {
              if (typeof window.startNewGame === 'function') {
                window.startNewGame();
              } else {
                console.error('startNewGame function not available');
                this.handleMissingFunction('startNewGame');
              }
            });
          }

          if (restartButton) {
            restartButton.addEventListener('click', () => {
              if (typeof window.restartGame === 'function') {
                window.restartGame();
              } else {
                this.handleMissingFunction('restartGame');
              }
            });
          }

          if (randomMoveButton) {
            randomMoveButton.addEventListener('click', () => {
              if (typeof window.makeRandomComputerMove === 'function') {
                window.makeRandomComputerMove();
              } else {
                this.handleMissingFunction('makeRandomComputerMove');
              }
            });
          }

          if (playAgainButton) {
            playAgainButton.addEventListener('click', () => {
              if (typeof window.handlePlayAgain === 'function') {
                window.handlePlayAgain();
              } else {
                this.handleMissingFunction('handlePlayAgain');
              }
            });
          }
        },

        // Handle missing function by attempting to load script.js
        async handleMissingFunction(functionName) {
          try {
            await window.scriptLoader.loadOnDemand('script.js');
            
            if (typeof window[functionName] === 'function') {
              window[functionName]();
            } else {
              throw new Error(`Function ${functionName} still not available after loading script.js`);
            }
          } catch (error) {
            console.error(`Failed to load ${functionName}:`, error);
            alert(`éŠæˆ²åŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼š${functionName}`);
          }
        },

        // Setup accessibility features
        setupAccessibilityFeatures() {
          // Load accessibility enhancements on demand
          if (window.scriptLoader) {
            window.scriptLoader.loadOnDemand('accessibility-enhancements.js').catch(error => {
              console.warn('Accessibility enhancements failed to load:', error);
            });
          }
        },

        // Setup language handling
        setupLanguageHandling() {
          // Load i18n module on demand
          if (window.scriptLoader) {
            window.scriptLoader.loadOnDemand('i18n.js').catch(error => {
              console.warn('Internationalization module failed to load:', error);
            });
          }

          // Setup language change listeners
          document.addEventListener('languageChanged', (event) => {
            this.handleLanguageChange(event.detail);
          });
        },

        // Setup development-only features
        setupDevelopmentFeatures() {
          // Load performance monitoring
          window.scriptLoader.loadOnDemand('performance-monitor.js').then(() => {
            if (window.performanceMonitor && !window.performanceMonitor.isMonitoring) {
              window.performanceMonitor.startMonitoring();
            }
          }).catch(error => {
            console.warn('Performance monitor failed to load:', error);
          });

          // Add debug information to console
          console.group('ğŸ”§ Development Mode Active');
          console.log('Environment:', this.state.environment);
          console.log('Script Loader:', window.scriptLoader);
          console.log('Module Loader:', window.moduleLoader);
          console.groupEnd();
        },

        // UI Helper Methods
        showLoadingState(message) {
          const loadingElement = document.getElementById('global-loading');
          const loadingText = document.querySelector('.loading-text');
          
          if (loadingElement) {
            loadingElement.style.display = 'flex';
          }
          
          if (loadingText) {
            loadingText.textContent = message;
            loadingText.style.color = '';
          }
        },

        hideLoadingState() {
          const loadingElement = document.getElementById('global-loading');
          if (loadingElement) {
            loadingElement.style.display = 'none';
          }
        },

        updateLoadingProgress(percentage, message) {
          this.state.loadingProgress = percentage;
          
          const loadingText = document.querySelector('.loading-text');
          if (loadingText) {
            loadingText.textContent = `${message} (${percentage}%)`;
          }
        },

        showInitializationSuccess() {
          if (this.state.environment === 'development') {
            console.log('ğŸ‰ Game initialization completed successfully');
          }
          
          // Show a brief success message
          const loadingText = document.querySelector('.loading-text');
          if (loadingText) {
            loadingText.textContent = 'è¼‰å…¥å®Œæˆï¼';
            loadingText.style.color = '#27ae60';
            
            setTimeout(() => {
              this.hideLoadingState();
            }, 500);
          }
        },

        handleInitializationError(error) {
          const loadingText = document.querySelector('.loading-text');
          if (loadingText) {
            loadingText.textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢';
            loadingText.style.color = '#e74c3c';
          }

          // Try to provide basic fallback after a delay
          setTimeout(() => {
            this.setupBasicFallback();
          }, 2000);
        },

        setupBasicFallback() {
          console.log('Setting up basic fallback functionality');
          
          const startButton = document.getElementById('start-game');
          if (startButton && !startButton.onclick) {
            startButton.addEventListener('click', () => {
              alert('éŠæˆ²è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦');
            });
          }
        },

        // Algorithm UI Management
        markAlgorithmsAsLoading() {
          const enhancedOption = document.querySelector('.algorithm-option[data-algorithm="enhanced"]');
          const aiOption = document.querySelector('.algorithm-option[data-algorithm="ai-learning"]');

          if (enhancedOption) {
            this.setAlgorithmState(enhancedOption, 'loading', 'æ­£åœ¨è¼‰å…¥å¢å¼·ç‰ˆæ¼”ç®—æ³•...');
          }

          if (aiOption) {
            this.setAlgorithmState(aiOption, 'loading', 'æ­£åœ¨è¼‰å…¥ AI å­¸ç¿’æ¼”ç®—æ³•...');
          }
        },

        showAlgorithmLoading(optionElement, algorithm) {
          const messages = {
            'enhanced': 'æ­£åœ¨è¼‰å…¥å¢å¼·ç‰ˆæ¼”ç®—æ³•...',
            'ai-learning': 'æ­£åœ¨è¼‰å…¥ AI å­¸ç¿’æ¼”ç®—æ³•...',
            'standard': 'åˆ‡æ›åˆ°æ¨™æº–æ¼”ç®—æ³•'
          };
          
          this.setAlgorithmState(optionElement, 'loading', messages[algorithm] || 'è¼‰å…¥ä¸­...');
        },

        showAlgorithmLoaded(optionElement, algorithm) {
          const messages = {
            'enhanced': 'å¢å¼·ç‰ˆæ¼”ç®—æ³•å·²è¼‰å…¥',
            'ai-learning': 'AI å­¸ç¿’æ¼”ç®—æ³•å·²è¼‰å…¥',
            'standard': 'æ¨™æº–æ¼”ç®—æ³•'
          };
          
          this.setAlgorithmState(optionElement, 'loaded', messages[algorithm] || 'å·²è¼‰å…¥');
        },

        showAlgorithmError(optionElement, error) {
          this.setAlgorithmState(optionElement, 'error', 'è¼‰å…¥å¤±æ•—');
        },

        setAlgorithmState(optionElement, state, message) {
          const stateStyles = {
            loading: { opacity: '0.5', cursor: 'wait' },
            loaded: { opacity: '1', cursor: 'pointer' },
            error: { opacity: '0.5', cursor: 'not-allowed' }
          };

          const style = stateStyles[state] || stateStyles.loaded;
          
          optionElement.style.opacity = style.opacity;
          optionElement.style.cursor = style.cursor;
          optionElement.title = message;
        },

        updateAlgorithmSelection(algorithm) {
          const algorithmOptions = document.querySelectorAll('.algorithm-option');
          algorithmOptions.forEach(opt => opt.classList.remove('selected'));

          const selectedOption = document.querySelector(`.algorithm-option[data-algorithm="${algorithm}"]`);
          if (selectedOption) {
            selectedOption.classList.add('selected');
          }

          // Update current algorithm display
          const currentAlgorithmName = document.getElementById('current-algorithm-name');
          if (currentAlgorithmName) {
            const algorithmNames = {
              'standard': 'æ¨™æº–æ¼”ç®—æ³•',
              'enhanced': 'å¢å¼·æ¼”ç®—æ³•',
              'ai-learning': 'AI å­¸ç¿’æ¼”ç®—æ³•'
            };
            currentAlgorithmName.textContent = algorithmNames[algorithm] || algorithm;
            currentAlgorithmName.setAttribute('data-algorithm', algorithm);
          }
        },

        handleLanguageChange(languageData) {
          // Update UI elements for language change
          this.updateAlgorithmSelection(this.state.currentAlgorithm);
        }
      };

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        BingoApp.initialize().catch(error => {
          console.error('Critical initialization failure:', error);
        });
      });

      // Expose BingoApp globally for debugging (development only)
      if (window.Environment && window.Environment.isDevelopment()) {
        window.BingoApp = BingoApp;
      }

      // Enable algorithm selection after loading
      function enableAlgorithmSelection() {
        const enhancedOption = document.querySelector(
          '.algorithm-option[data-algorithm="enhanced"]'
        );
        if (
          enhancedOption &&
          typeof EnhancedProbabilityCalculator !== 'undefined'
        ) {
          enhancedOption.style.opacity = '1';
          enhancedOption.style.cursor = 'pointer';
          enhancedOption.title = 'é»æ“Šåˆ‡æ›åˆ°å¢å¼·ç‰ˆæ¼”ç®—æ³•';
        }

        const aiOption = document.querySelector(
          '.algorithm-option[data-algorithm="ai-learning"]'
        );
        if (aiOption && typeof AILearningSystem !== 'undefined') {
          aiOption.style.opacity = '1';
          aiOption.style.cursor = 'pointer';
          aiOption.title = 'é»æ“Šåˆ‡æ›åˆ° AI å­¸ç¿’æ¼”ç®—æ³•';
        }
      }

      // Switch algorithm implementation
      function switchAlgorithm(algorithm) {
        if (algorithm === currentAlgorithm) {
          return;
        }

        currentAlgorithm = algorithm;

        // Update current algorithm display
        const currentAlgorithmName = document.getElementById(
          'current-algorithm-name'
        );
        if (currentAlgorithmName) {
          currentAlgorithmName.setAttribute('data-algorithm', algorithm);
          const algorithmKey = `algorithm.${algorithm}.name`;
          if (typeof i18n !== 'undefined') {
            currentAlgorithmName.textContent = i18n.t(algorithmKey);
          } else {
            // Fallback text
            const algorithmNames = {
              standard: 'æ¨™æº–æ¼”ç®—æ³•',
              enhanced: 'å¢å¼·æ¼”ç®—æ³•',
              'ai-learning': 'AI å­¸ç¿’æ¼”ç®—æ³•'
            };
            currentAlgorithmName.textContent =
              algorithmNames[algorithm] || algorithm;
          }
        }

        // Update global probabilityCalculator instance
        if (typeof probabilityCalculator !== 'undefined') {
          if (
            algorithm === 'standard' &&
            typeof ProbabilityCalculator !== 'undefined'
          ) {
            probabilityCalculator = new ProbabilityCalculator();
          } else if (
            algorithm === 'enhanced' &&
            typeof EnhancedProbabilityCalculator !== 'undefined'
          ) {
            probabilityCalculator = new EnhancedProbabilityCalculator();
          } else if (
            algorithm === 'ai-learning' &&
            typeof AILearningSystem !== 'undefined'
          ) {
            // AI learning system integration would go here
            console.log('AI learning algorithm selected');
          }
        }

        // Reinitialize game if it was already started
        if (
          typeof initializeGame === 'function' &&
          typeof gameState !== 'undefined'
        ) {
          const wasGameStarted = gameState.gameStarted;

          if (typeof window.initializeGame === 'function') {
            window.initializeGame();
          }

          if (
            wasGameStarted &&
            !gameState.gameEnded &&
            typeof startNewGame === 'function'
          ) {
            startNewGame();
          }

          // Show success message
          showAlgorithmSwitchMessage(algorithm);
        }
      }

      // Show algorithm switch success message
      function showAlgorithmSwitchMessage(algorithm) {
        const instructionText = document.getElementById('instruction-text');
        if (instructionText) {
          const algorithmNames = {
            standard: 'æ¨™æº–æ¼”ç®—æ³•',
            enhanced: 'å¢å¼·æ¼”ç®—æ³•',
            'ai-learning': 'AI å­¸ç¿’æ¼”ç®—æ³•'
          };

          const algorithmName = algorithmNames[algorithm] || algorithm;
          const message =
            typeof i18n !== 'undefined'
              ? i18n.t('success.algorithm-switched', {
                  algorithm: algorithmName
                })
              : `å·²åˆ‡æ›åˆ°${algorithmName}`;

          instructionText.textContent = message;
          instructionText.classList.add('success');

          setTimeout(() => {
            const defaultMessage =
              typeof i18n !== 'undefined'
                ? i18n.t('instructions.default')
                : 'é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•é–‹å§‹æ–°çš„éŠæˆ²ã€‚ä½¿ç”¨æ–¹å‘éµå°èˆªéŠæˆ²æ¿ï¼ŒæŒ‰ Enter æˆ–ç©ºæ ¼éµé¸æ“‡æ ¼å­ã€‚';
            instructionText.textContent = defaultMessage;
            instructionText.classList.remove('success');
          }, 3000);
        }
      }

      // Setup other UI components
      function setupUIComponents() {
        // Enable algorithm selection for loaded modules
        setTimeout(() => {
          enableAlgorithmSelection();
        }, 1000);

        // Setup performance monitoring display (development mode only)
        if (window.Environment && window.Environment.isDevelopment()) {
          setupPerformanceDisplay();
        }
      }

      // Setup performance monitoring display (development mode)
      function setupPerformanceDisplay() {
        const debugPanel = document.getElementById('debug-panel');
        if (debugPanel && window.scriptLoader) {
          const performanceButton = document.createElement('button');
          performanceButton.className = 'debug-btn';
          performanceButton.textContent = 'é¡¯ç¤ºè¼‰å…¥æ€§èƒ½';
          performanceButton.onclick = () => {
            const status = window.scriptLoader.getStatus();
            console.log('Script Loader Performance:', status.performance);

            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
              debugInfo.innerHTML = `
                            <h4>è¼‰å…¥æ€§èƒ½å ±å‘Š</h4>
                            <p>ç¸½è¼‰å…¥æ™‚é–“: ${status.performance.totalLoadTime.toFixed(2)}ms</p>
                            <p>é—œéµè·¯å¾‘æ™‚é–“: ${status.performance.criticalPathTime.toFixed(2)}ms</p>
                            <p>æˆåŠŸè¼‰å…¥æ¨¡çµ„: ${status.performance.successfulLoads}/${status.performance.moduleCount}</p>
                            <p>å¹³å‡è¼‰å…¥æ™‚é–“: ${status.performance.averageLoadTime.toFixed(2)}ms</p>
                            ${status.performance.errors.length > 0 ? `<p style="color: red;">éŒ¯èª¤: ${status.performance.errors.length}</p>` : ''}
                            ${status.performance.warnings.length > 0 ? `<p style="color: orange;">è­¦å‘Š: ${status.performance.warnings.length}</p>` : ''}
                        `;
            }
          };

          const debugControls = debugPanel.querySelector('.debug-controls');
          if (debugControls) {
            debugControls.appendChild(performanceButton);
          }
        }
      }

      // Initialize game when DOM is ready
      document.addEventListener('DOMContentLoaded', function () {
        // Small delay to ensure script-loader.js is fully loaded
        setTimeout(() => {
          if (window.scriptLoader) {
            initializeGame();
          } else {
            console.error(
              'Script loader not available, falling back to basic initialization'
            );
            setupBasicFallback();
          }
        }, 100);
      });

      // Global error handler for unhandled errors
      window.addEventListener('error', function (event) {
        console.error('Global error:', event.error);

        if (!gameInitialized) {
          // If game hasn't initialized yet, try fallback
          setupBasicFallback();
        }
      });

      // Expose functions to global scope for compatibility
      window.enableAlgorithmSelection = enableAlgorithmSelection;
      window.switchAlgorithm = switchAlgorithm;
      window.currentAlgorithm = currentAlgorithm;
    </script>

    <!-- PWA Installation Script -->
    <script>
      // è™•ç† PWA å¿«æ·æ–¹å¼åƒæ•¸
      const urlParams = new URLSearchParams(window.location.search);
      const action = urlParams.get('action');

      if (action === 'new-game') {
        // è‡ªå‹•é–‹å§‹æ–°éŠæˆ²
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
            const startButton = document.getElementById('start-game');
            if (startButton && !startButton.disabled) {
              startButton.click();
            }
          }, 1000);
        });
      } else if (action === 'stats') {
        // é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
            if (typeof gestureSupport !== 'undefined' && gestureSupport) {
              gestureSupport.showGameStats();
            }
          }, 1000);
        });
      }

      // æ€§èƒ½ç›£æ§
      if ('performance' in window) {
        window.addEventListener('load', () => {
          // è¨˜éŒ„é é¢åŠ è¼‰æ€§èƒ½
          const perfData = performance.getEntriesByType('navigation')[0];
          if (perfData) {
            if (window.logger) {
              window.logger.info(
                'Page load time:',
                perfData.loadEventEnd - perfData.fetchStart,
                'ms'
              );
            }
          }

          // è¨˜éŒ„è³‡æºåŠ è¼‰æ€§èƒ½
          const resources = performance.getEntriesByType('resource');
          resources.forEach(resource => {
            if (resource.duration > 1000) {
              if (window.logger) {
                window.logger.warn(
                  'Slow resource:',
                  resource.name,
                  resource.duration,
                  'ms'
                );
              }
            }
          });
        });
      }

      // é›¢ç·šç‹€æ…‹è™•ç†
      window.addEventListener('online', () => {
        if (window.logger) {
          window.logger.info('App is online');
        }
        // å¯ä»¥åœ¨é€™è£¡åŒæ­¥é›¢ç·šæ™‚çš„æ•¸æ“š
      });

      window.addEventListener('offline', () => {
        if (window.logger) {
          window.logger.info('App is offline');
        }
        // å¯ä»¥åœ¨é€™è£¡ä¿å­˜ç•¶å‰ç‹€æ…‹
      });

      // èªè¨€è®Šæ›´äº‹ä»¶è™•ç†
      document.addEventListener('languageChanged', event => {
        if (window.logger) {
          window.logger.info(
            'Language changed event received:',
            event.detail.language
          );
        }

        // æ›´æ–°éŠæˆ²ç‹€æ…‹é¡¯ç¤º
        updateGameStatusLanguage();

        // æ›´æ–°å»ºè­°é¡¯ç¤º
        updateSuggestionLanguage();

        // æ›´æ–°æŒ‡ç¤ºæ–‡å­—
        updateInstructionsLanguage();

        // æ›´æ–°æ¼”ç®—æ³•åç¨±
        updateAlgorithmNamesLanguage();
      });

      // æ›´æ–°éŠæˆ²ç‹€æ…‹çš„èªè¨€
      function updateGameStatusLanguage() {
        if (typeof gameState !== 'undefined' && gameState) {
          const currentRound = document.getElementById('current-round');
          const gamePhase = document.getElementById('game-phase');

          if (currentRound && gameState.currentRound) {
            // ä¿æŒæ•¸å­—ï¼Œåªæ›´æ–°æ ¼å¼
            currentRound.textContent = gameState.currentRound.toString();
          }

          if (gamePhase && gameState.gamePhase) {
            const phaseKey = `phase.${gameState.gamePhase}`;
            if (typeof i18n !== 'undefined') {
              gamePhase.textContent = i18n.t(phaseKey);
            }
          }
        }
      }

      // æ›´æ–°å»ºè­°é¡¯ç¤ºçš„èªè¨€
      function updateSuggestionLanguage() {
        const suggestionText = document.getElementById('suggestion-text');
        if (suggestionText && typeof i18n !== 'undefined') {
          // å¦‚æœé¡¯ç¤ºçš„æ˜¯é»˜èªå»ºè­°æ–‡å­—ï¼Œæ›´æ–°å®ƒ
          if (
            suggestionText.textContent.includes('é»æ“Šé–‹å§‹éŠæˆ²') ||
            suggestionText.textContent.includes('Click Start Game')
          ) {
            suggestionText.textContent = i18n.t('suggestion.default');
          }
        }
      }

      // æ›´æ–°æŒ‡ç¤ºæ–‡å­—çš„èªè¨€
      function updateInstructionsLanguage() {
        const instructionText = document.getElementById('instruction-text');
        if (instructionText && typeof i18n !== 'undefined') {
          // æ ¹æ“šç•¶å‰éŠæˆ²ç‹€æ…‹æ›´æ–°æŒ‡ç¤º
          if (typeof gameState !== 'undefined' && gameState) {
            if (!gameState.gameStarted) {
              instructionText.textContent = i18n.t('instructions.default');
            } else if (gameState.gameEnded) {
              instructionText.textContent = i18n.t('instructions.game-over');
            } else if (gameState.gamePhase === 'player-turn') {
              instructionText.textContent = i18n.t('instructions.player-turn');
            } else if (gameState.gamePhase === 'computer-turn') {
              instructionText.textContent = i18n.t(
                'instructions.computer-turn'
              );
            }
          } else {
            instructionText.textContent = i18n.t('instructions.default');
          }
        }
      }

      // æ›´æ–°æ¼”ç®—æ³•åç¨±çš„èªè¨€
      function updateAlgorithmNamesLanguage() {
        const currentAlgorithmName = document.getElementById(
          'current-algorithm-name'
        );
        if (currentAlgorithmName && typeof i18n !== 'undefined') {
          const algorithmType =
            currentAlgorithmName.getAttribute('data-algorithm') || 'standard';
          const algorithmKey = `algorithm.${algorithmType}.name`;
          currentAlgorithmName.textContent = i18n.t(algorithmKey);
        }
      }
    </script>
  </body>
</html>
